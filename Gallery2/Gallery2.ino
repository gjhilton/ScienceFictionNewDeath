/////////////////////////////////////////////////////////////////////////////////////////////////
//
//
// ARDUINO DUEMILANOVE - ARDUINO DUEMILANOVE - ARDUINO DUEMILANOVE - ARDUINO DUEMILANOVE 
//
//
////////////////////////////////////////////////////////////////////////////////////////////////

#include <SoftwareSerial.h>
#include <MP3Trigger.h>
#include <MotionTrigger.h>
#include "Throbber.h"

/////////////////////////////////////////////////////////////////////////////////////////////////
// CONFIGURATION
////////////////////////////////////////////////////////////////////////////////////////////////

#define PING_PIN 7
#define RANGE_NEAR 156
#define RANGE_FAR 1550

#define TOP_LIGHT_PIN 3
#define LEFT_LIGHT_PIN 5
#define RIGHT_LIGHT_PIN 6

#define SERIAL_BAUD 57600

#define MP3_TX 11
#define MP3_RX 12

SoftwareSerial trigSerial = SoftwareSerial(MP3_RX, MP3_TX);
MP3Trigger trigger;

/////////////////////////////////////////////////////////////////////////////////////////////////
// DECLARATIONS
////////////////////////////////////////////////////////////////////////////////////////////////

MotionTrigger motiontrigger(PING_PIN,RANGE_NEAR,RANGE_FAR);
Throbber throb(TOP_LIGHT_PIN,LEFT_LIGHT_PIN,RIGHT_LIGHT_PIN);

/////////////////////////////////////////////////////////////////////////////////////////////////
// ARDUINO LIFECYCLE
////////////////////////////////////////////////////////////////////////////////////////////////

void setup() {
  Serial.begin(SERIAL_BAUD);
  motiontrigger.begin(&onTrigger,&onDetrigger);
  throb.setup();
  
  trigger.setup(&trigSerial);
  trigSerial.begin( MP3Trigger::serialRate() );
  trigger.setLooping(true,6);
}

void loop() {
  motiontrigger.loop();
  throb.loop();
  trigger.update();
  delay(20);
}

/////////////////////////////////////////////////////////////////////////////////////////////////
// CALLBACKS FOR MOTION TRIGGER
////////////////////////////////////////////////////////////////////////////////////////////////

void onTrigger(){
  Serial.println("TRIGGER");
  throb.cue();
  trigger.play(2);
}

void onDetrigger(){
  Serial.println("RELAX");
  throb.reset();
  //trigger.setLooping(true,2);
}
